name: Branch Policy Enforcement

on:
  pull_request:
    branches:
      - main
    types: [opened, reopened, synchronize]

jobs:
  enforce-branch-policy:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write

    steps:
      - name: Check source branch
        id: check
        run: |
          if [ "${{ github.head_ref }}" != "dev" ]; then
            echo "allowed=false" >> $GITHUB_OUTPUT
            echo "‚ùå Branch policy violation detected!"
            echo "::error::Only 'dev' branch can merge to 'main'"
            echo "::error::Current source branch: ${{ github.head_ref }}"
            exit 1
          else
            echo "allowed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Branch policy check passed!"
            echo "::notice::Source branch 'dev' is allowed to merge to 'main'"
          fi

      - name: Success - Dev branch detected
        if: github.head_ref == 'dev'
        run: |
          echo "üéâ Branch Policy Enforcement: SUCCESS"
          echo "================================================"
          echo "‚úÖ Source Branch: dev"
          echo "‚úÖ Target Branch: main"
          echo "‚úÖ Status: Policy compliant - merge allowed"
          echo "================================================"

      - name: Block illegal merge
        if: github.head_ref != 'dev'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          echo "üö´ Blocking merge - sending review comment..."
          gh pr review "$PR_URL" \
            --request-changes \
            --body "üö´ **Branch Policy Violation**

          Direct merges to \`main\` are only allowed from the \`dev\` branch.
          
          **Current source**: \`${{ github.head_ref }}\`
          **Required source**: \`dev\`
          
          Please merge your changes into \`dev\` first, then create a PR from \`dev\` to \`main\`."
          
      - name: Fail workflow if policy violated
        if: github.head_ref != 'dev'
        run: |
          echo "‚ùå WORKFLOW FAILED: Branch policy violation"
          exit 1
